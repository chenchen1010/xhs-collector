# 小红书采集 FastAPI 服务 - 阿里云部署指南

## 一、服务器环境准备

### 1.1 系统要求
- 操作系统：Ubuntu 20.04/22.04 或 CentOS 7/8
- Python 3.8+
- 至少 1GB 内存
- 至少 10GB 磁盘空间

### 1.2 连接到服务器
```bash
ssh root@你的服务器IP
```

### 1.3 更新系统并安装基础依赖（Ubuntu）
```bash
# 更新软件包列表
sudo apt update
sudo apt upgrade -y

# 安装必要工具
sudo apt install -y python3 python3-pip python3-venv nginx git curl
```

### 1.3 更新系统并安装基础依赖（CentOS）
```bash
# 更新软件包
sudo yum update -y

# 安装必要工具
sudo yum install -y python3 python3-pip nginx git curl
```

## 二、部署 FastAPI 应用

### 2.1 创建项目目录
```bash
# 创建应用目录
sudo mkdir -p /opt/xhs-collector
cd /opt/xhs-collector

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate
```

### 2.2 上传项目文件
有两种方式上传代码：

**方式1：使用 Git（推荐）**
```bash
# 如果代码在 Git 仓库中
git clone your-repo-url .
```

**方式2：使用 SCP 从本地上传**
```bash
# 在本地终端执行（不是服务器）
scp -r "/Users/burning/Desktop/Code/Coze代码开发/小红书采集Fastapi方案"/* root@你的服务器IP:/opt/xhs-collector/
```

### 2.3 安装 Python 依赖
```bash
cd /opt/xhs-collector
source venv/bin/activate
pip install --upgrade pip
pip install fastapi uvicorn[standard] requests python-dotenv pydantic
```

### 2.4 创建 .env 配置文件
```bash
cat > /opt/xhs-collector/.env << 'EOF'
# 小红书相关配置
XHS_COOKIE=你的Cookie值

# 服务器配置
HOST=0.0.0.0
PORT=8000

# 日志级别
LOG_LEVEL=info
EOF
```

**重要：将 .env 中的 Cookie 替换为您的真实 Cookie**

### 2.5 测试 FastAPI 应用
```bash
# 激活虚拟环境
source /opt/xhs-collector/venv/bin/activate

# 启动测试（按 Ctrl+C 停止）
cd /opt/xhs-collector
uvicorn main:app --host 0.0.0.0 --port 8000
```

在浏览器访问：`http://你的服务器IP:8000/docs` 查看 API 文档

## 三、配置 Systemd 服务（开机自启）

### 3.1 创建 Systemd 服务文件
```bash
sudo cat > /etc/systemd/system/xhs-collector.service << 'EOF'
[Unit]
Description=Xiaohongshu Collector FastAPI Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/xhs-collector
Environment="PATH=/opt/xhs-collector/venv/bin"
ExecStart=/opt/xhs-collector/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 2
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF
```

### 3.2 启动并启用服务
```bash
# 重新加载 systemd 配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start xhs-collector

# 设置开机自启
sudo systemctl enable xhs-collector

# 查看服务状态
sudo systemctl status xhs-collector

# 查看日志
sudo journalctl -u xhs-collector -f
```

### 3.3 常用服务管理命令
```bash
# 启动服务
sudo systemctl start xhs-collector

# 停止服务
sudo systemctl stop xhs-collector

# 重启服务
sudo systemctl restart xhs-collector

# 查看状态
sudo systemctl status xhs-collector

# 查看日志
sudo journalctl -u xhs-collector -f -n 100
```

## 四、配置 Nginx 反向代理（可选但推荐）

### 4.1 创建 Nginx 配置文件
```bash
sudo cat > /etc/nginx/sites-available/xhs-collector << 'EOF'
server {
    listen 80;
    server_name 你的域名或IP;

    # 限制请求体大小
    client_max_body_size 10M;

    # API 路由
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
EOF
```

### 4.2 启用 Nginx 配置
```bash
# 创建软链接启用配置
sudo ln -s /etc/nginx/sites-available/xhs-collector /etc/nginx/sites-enabled/

# 测试 Nginx 配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx

# 设置 Nginx 开机自启
sudo systemctl enable nginx
```

### 4.3 访问测试
- 通过 Nginx：`http://你的服务器IP/docs`
- 直接访问：`http://你的服务器IP:8000/docs`

## 五、安全配置

### 5.1 配置防火墙（Ubuntu - UFW）
```bash
# 启用防火墙
sudo ufw enable

# 允许 SSH
sudo ufw allow 22/tcp

# 允许 HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 如果不使用 Nginx，允许 8000 端口
# sudo ufw allow 8000/tcp

# 查看防火墙状态
sudo ufw status
```

### 5.2 配置防火墙（CentOS - Firewalld）
```bash
# 启动防火墙
sudo systemctl start firewalld
sudo systemctl enable firewalld

# 允许 HTTP/HTTPS
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https

# 如果不使用 Nginx，允许 8000 端口
# sudo firewall-cmd --permanent --add-port=8000/tcp

# 重新加载防火墙
sudo firewall-cmd --reload
```

### 5.3 阿里云安全组配置
在阿里云控制台配置安全组规则：
1. 登录阿里云控制台
2. 进入 ECS 实例 → 安全组
3. 添加入方向规则：
   - 端口 80（HTTP）
   - 端口 443（HTTPS，如果配置 SSL）
   - 端口 22（SSH）
   - 端口 8000（如果不使用 Nginx）

## 六、配置 HTTPS（可选但推荐）

### 6.1 安装 Certbot（Let's Encrypt 免费 SSL）
```bash
# Ubuntu
sudo apt install -y certbot python3-certbot-nginx

# CentOS
sudo yum install -y certbot python3-certbot-nginx
```

### 6.2 获取 SSL 证书
```bash
# 确保域名已解析到服务器 IP
sudo certbot --nginx -d 你的域名

# 自动续期测试
sudo certbot renew --dry-run
```

### 6.3 更新后的 Nginx 配置（HTTPS）
Certbot 会自动修改 Nginx 配置，或者手动修改：
```bash
sudo cat > /etc/nginx/sites-available/xhs-collector << 'EOF'
server {
    listen 80;
    server_name 你的域名;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name 你的域名;

    ssl_certificate /etc/letsencrypt/live/你的域名/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/你的域名/privkey.pem;

    client_max_body_size 10M;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
EOF

sudo nginx -t
sudo systemctl reload nginx
```

## 七、Coze 集成配置

### 7.1 在 Coze 中使用 HTTP 请求节点

**节点配置示例：**

1. **采集单篇笔记**
   - 请求方式：POST
   - URL：`http://你的服务器IP/api/note/single` 或 `https://你的域名/api/note/single`
   - Content-Type：`application/json`
   - Body（JSON）：
   ```json
   {
     "note_url": "{{输入变量.笔记链接}}"
   }
   ```

2. **采集博主所有笔记**
   - 请求方式：POST
   - URL：`http://你的服务器IP/api/user/notes`
   - Body：
   ```json
   {
     "user_url": "{{输入变量.博主主页链接}}"
   }
   ```

3. **采集博主信息**
   - 请求方式：POST
   - URL：`http://你的服务器IP/api/user/info`
   - Body：
   ```json
   {
     "user_url": "{{输入变量.博主主页链接}}"
   }
   ```

### 7.2 响应数据处理
HTTP 节点返回的 JSON 需要用代码节点转换为多维表格格式：

```javascript
async function main({ params }: Args): Promise<Output> {
    const apiResponse = params.http_response; // HTTP 节点的输出

    // 提取 records
    const records = apiResponse.records || [];

    return {
        records: records
    };
}
```

## 八、监控与维护

### 8.1 日志管理
```bash
# 查看实时日志
sudo journalctl -u xhs-collector -f

# 查看最近 100 行日志
sudo journalctl -u xhs-collector -n 100

# 查看今天的日志
sudo journalctl -u xhs-collector --since today

# 日志轮转（防止日志过大）
sudo journalctl --vacuum-size=100M
```

### 8.2 性能监控
```bash
# 查看服务资源占用
sudo systemctl status xhs-collector

# 查看进程
ps aux | grep uvicorn

# 查看端口监听
sudo netstat -tlnp | grep 8000
```

### 8.3 更新代码
```bash
# 停止服务
sudo systemctl stop xhs-collector

# 更新代码（Git 方式）
cd /opt/xhs-collector
git pull

# 或者用 SCP 上传新代码
# scp -r 本地文件/* root@服务器IP:/opt/xhs-collector/

# 重新安装依赖（如果有更新）
source venv/bin/activate
pip install -r requirements.txt

# 启动服务
sudo systemctl start xhs-collector

# 查看日志确认启动成功
sudo journalctl -u xhs-collector -f
```

### 8.4 Cookie 更新
```bash
# 编辑 .env 文件
sudo nano /opt/xhs-collector/.env

# 修改 XHS_COOKIE 值后保存（Ctrl+O, Enter, Ctrl+X）

# 重启服务使配置生效
sudo systemctl restart xhs-collector
```

## 九、常见问题排查

### 9.1 服务无法启动
```bash
# 查看详细错误日志
sudo journalctl -u xhs-collector -n 50

# 检查端口是否被占用
sudo netstat -tlnp | grep 8000

# 手动启动查看错误
cd /opt/xhs-collector
source venv/bin/activate
uvicorn main:app --host 0.0.0.0 --port 8000
```

### 9.2 无法访问 API
```bash
# 检查防火墙
sudo ufw status  # Ubuntu
sudo firewall-cmd --list-all  # CentOS

# 检查 Nginx 状态
sudo systemctl status nginx
sudo nginx -t

# 检查阿里云安全组规则
# 在阿里云控制台确认端口已开放
```

### 9.3 签名验证失败
```bash
# 检查 Cookie 是否有效
# 编辑 .env 更新 Cookie
sudo nano /opt/xhs-collector/.env

# 重启服务
sudo systemctl restart xhs-collector
```

### 9.4 API 响应 406 或 461 错误
- 406：签名验证失败，检查签名算法或 Cookie
- 461：xsec_token 过期，需要刷新链接中的 token

## 十、备份与恢复

### 10.1 备份重要文件
```bash
# 创建备份目录
sudo mkdir -p /opt/backups

# 备份配置和代码
sudo tar -czf /opt/backups/xhs-collector-$(date +%Y%m%d).tar.gz \
    /opt/xhs-collector \
    /etc/systemd/system/xhs-collector.service \
    /etc/nginx/sites-available/xhs-collector

# 定期备份（添加到 crontab）
sudo crontab -e
# 添加：每天凌晨 2 点备份
0 2 * * * tar -czf /opt/backups/xhs-collector-$(date +\%Y\%m\%d).tar.gz /opt/xhs-collector
```

## 十一、性能优化建议

### 11.1 调整 Worker 数量
```bash
# 编辑 systemd 服务文件
sudo nano /etc/systemd/system/xhs-collector.service

# 修改 workers 参数（根据 CPU 核心数调整）
ExecStart=/opt/xhs-collector/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4

# 重新加载并重启
sudo systemctl daemon-reload
sudo systemctl restart xhs-collector
```

### 11.2 启用 Nginx 缓存（如适用）
```nginx
# 在 /etc/nginx/sites-available/xhs-collector 的 http 块中添加
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=100m inactive=60m;

# 在 location 块中添加
proxy_cache api_cache;
proxy_cache_valid 200 5m;
```

## 十二、总结

完成上述步骤后，您将拥有：
- ✅ 在阿里云服务器运行的 FastAPI 服务
- ✅ 开机自启的 Systemd 服务管理
- ✅ Nginx 反向代理（可选 HTTPS）
- ✅ 防火墙和安全组配置
- ✅ 日志管理和监控
- ✅ 与 Coze 的集成方案

**快速启动检查清单：**
1. [ ] 服务器环境准备完成
2. [ ] 代码上传到 `/opt/xhs-collector`
3. [ ] 依赖安装完成
4. [ ] `.env` 配置完成（Cookie 已更新）
5. [ ] Systemd 服务启动成功
6. [ ] 防火墙和安全组配置完成
7. [ ] Nginx 配置完成（如使用）
8. [ ] API 测试通过（访问 `/docs`）
9. [ ] Coze HTTP 节点配置完成
10. [ ] 端到端测试通过
